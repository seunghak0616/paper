<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papers RAG 챗봇</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f7f7f7; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 18px; max-width: 70%; line-height: 1.5; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .bot-message { background-color: #e9e9eb; color: #333; align-self: flex-start; }
        .bot-message p { margin: 0; }
        #form { display: flex; padding: 10px; border-top: 1px solid #ddd; background-color: #fff; }
        #input { flex-grow: 1; border: 1px solid #ccc; border-radius: 18px; padding: 10px 15px; font-size: 16px; }
        #input:focus { outline: none; border-color: #007bff; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; margin-left: 10px; border-radius: 18px; cursor: pointer; font-size: 16px; }
        button:disabled { background-color: #a0cfff; cursor: not-allowed; }
        #messages-container { display: flex; flex-direction: column; width: 100%; }
    </style>
</head>
<body>
    <div id="messages">
        <div id="messages-container">
             <div class="message bot-message"><p>안녕하세요! 논문에 대해 궁금한 점을 질문해주세요.</p></div>
        </div>
    </div>
    <form id="form" action="">
        <input id="input" autocomplete="off" placeholder="메시지를 입력하세요..." />
        <button>전송</button>
    </form>
    <script>
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messagesContainer = document.getElementById('messages-container');
        const messages = document.getElementById('messages');
        const sendButton = form.querySelector('button');

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/chat`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log('WebSocket 연결 성공');
        };

        ws.onmessage = (event) => {
            const message = event.data;
            if (message === "[DONE]") {
                sendButton.disabled = false;
                input.disabled = false;
                input.focus();
                return;
            }
            
            let lastBotMessage = messagesContainer.querySelector('.bot-message:last-child p');
            if (lastBotMessage && !lastBotMessage.closest('.message').__done) {
                 lastBotMessage.textContent += message;
            } else {
                const botMessageElem = document.createElement('div');
                botMessageElem.classList.add('message', 'bot-message');
                const p = document.createElement('p');
                p.textContent = message;
                botMessageElem.appendChild(p);
                messagesContainer.appendChild(botMessageElem);
            }
            messages.scrollTop = messages.scrollHeight;
        };

        ws.onerror = (error) => {
            console.error('WebSocket 오류:', error);
            const errorElem = document.createElement('div');
            errorElem.classList.add('message', 'bot-message');
            errorElem.innerHTML = '<p>연결에 오류가 발생했습니다. 페이지를 새로고침 해주세요.</p>';
            messagesContainer.appendChild(errorElem);
        };
        
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!input.value.trim() || ws.readyState !== WebSocket.OPEN) return;
            
            const userMessage = input.value;
            const userMessageElem = document.createElement('div');
            userMessageElem.classList.add('message', 'user-message');
            userMessageElem.textContent = userMessage;
            messagesContainer.appendChild(userMessageElem);
            messages.scrollTop = messages.scrollHeight;

            ws.send(userMessage);
            
            // Mark the last bot message as done so we create a new one
            const lastBotMessage = messagesContainer.querySelector('.bot-message:last-child');
            if(lastBotMessage) lastBotMessage.__done = true;

            input.value = '';
            sendButton.disabled = true;
            input.disabled = true;
        });
    </script>
</body>
</html> 